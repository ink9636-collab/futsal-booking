<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <meta name="mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="default">
  <meta name="apple-mobile-web-app-title" content="풋살예약">
  <title>풋살공간 예약관리</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
  <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <style>
    body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; }
    * { -webkit-tap-highlight-color: transparent; box-sizing: border-box; }
    html, body { touch-action: manipulation; -webkit-overflow-scrolling: touch; }
    input, select, textarea { font-size: 16px !important; }
    input[type="date"] { min-height: 36px; }
  </style>
</head>
<body>
  <div id="root"></div>
  <script type="text/babel">
    const { useState, useEffect } = React;

    // 간단한 아이콘 컴포넌트들
    const Icon = ({ children, size = 24, className = "" }) => (
      <svg xmlns="http://www.w3.org/2000/svg" width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}>{children}</svg>
    );
    const CalendarIcon = ({ size, className }) => <Icon size={size} className={className}><rect x="3" y="4" width="18" height="18" rx="2" ry="2"/><line x1="16" y1="2" x2="16" y2="6"/><line x1="8" y1="2" x2="8" y2="6"/><line x1="3" y1="10" x2="21" y2="10"/></Icon>;
    const XIcon = ({ size, className }) => <Icon size={size} className={className}><line x1="18" y1="6" x2="6" y2="18"/><line x1="6" y1="6" x2="18" y2="18"/></Icon>;
    const BarChartIcon = ({ size, className }) => <Icon size={size} className={className}><line x1="12" y1="20" x2="12" y2="10"/><line x1="18" y1="20" x2="18" y2="4"/><line x1="6" y1="20" x2="6" y2="16"/></Icon>;
    const ListIcon = ({ size, className }) => <Icon size={size} className={className}><line x1="8" y1="6" x2="21" y2="6"/><line x1="8" y1="12" x2="21" y2="12"/><line x1="8" y1="18" x2="21" y2="18"/><line x1="3" y1="6" x2="3.01" y2="6"/><line x1="3" y1="12" x2="3.01" y2="12"/><line x1="3" y1="18" x2="3.01" y2="18"/></Icon>;
    const EditIcon = ({ size, className }) => <Icon size={size} className={className}><path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"/><path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"/></Icon>;
    const TrashIcon = ({ size, className }) => <Icon size={size} className={className}><polyline points="3 6 5 6 21 6"/><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"/></Icon>;
    const RefreshIcon = ({ size, className }) => <Icon size={size} className={className}><polyline points="23 4 23 10 17 10"/><path d="M20.49 15a9 9 0 1 1-2.12-9.36L23 10"/></Icon>;

    // Supabase 설정
    const SUPABASE_URL = 'https://ltkjopawqjdzoqegbkaz.supabase.co';
    const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Imx0a2pvcGF3cWpkem9xZWdia2F6Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjkwOTk2MjksImV4cCI6MjA4NDY3NTYyOX0.BknFqHiwMn2hxo_FRNbwMW3V-anq-EzpsUdhmb_cJw0';
    const db = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

    const FutsalBookingSystem = () => {
      const [selectedVenue, setSelectedVenue] = useState('전체');
      const [selectedCourt, setSelectedCourt] = useState('');
      const [currentDate, setCurrentDate] = useState(new Date());
      const [view, setView] = useState('calendar');
      const [bookings, setBookings] = useState([]);
      const [loading, setLoading] = useState(true);
      const [showModal, setShowModal] = useState(false);
      const [showDetailModal, setShowDetailModal] = useState(false);
      const [selectedBooking, setSelectedBooking] = useState(null);
      const [detailData, setDetailData] = useState([]);
      const [detailTitle, setDetailTitle] = useState('');
      const [deleteId, setDeleteId] = useState(null);
      const [deletePassword, setDeletePassword] = useState('');
      const [isEditMode, setIsEditMode] = useState(false);
      const [overlapAlert, setOverlapAlert] = useState(null);
      const [showCancelModal, setShowCancelModal] = useState(null);
      const [cancelReason, setCancelReason] = useState('');
      const [requiredAlert, setRequiredAlert] = useState(false);
      const [newBooking, setNewBooking] = useState({
        venue: '세마', court: '단일구장', date: '', startTime: '06:00', endTime: '08:00',
        category: '대관', customerName: '', phone: '', route: '전화', status: 'active'
      });
      const [customDateRange, setCustomDateRange] = useState({ start: '', end: '' });
      const [searchQuery, setSearchQuery] = useState('');
      const [listVenue, setListVenue] = useState('전체');
      const [displayCount, setDisplayCount] = useState(20);
      const [editingBookingId, setEditingBookingId] = useState(null);

      const venues = { '세마': ['단일구장'], '군포': ['1구장', '2구장'], '춘의': ['단일구장'] };
      const categories = { '대관': 'bg-blue-500', '소셜매치': 'bg-green-500', '아카데미': 'bg-purple-500' };
      const timeSlots = Array.from({length: 36}, (_, i) => `${String(Math.floor(i/2) + 6).padStart(2, '0')}:${String((i % 2) * 30).padStart(2, '0')}`);

      useEffect(() => { loadBookings(); }, []);

      const loadBookings = async () => {
        setLoading(true);
        try {
          const { data, error } = await db
            .from('bookings')
            .select('*')
            .order('date', { ascending: false });
          
          if (error) throw error;
          
          const formattedData = data.map(b => ({
            id: b.id,
            venue: b.venue,
            court: b.court,
            date: b.date,
            startTime: b.start_time,
            endTime: b.end_time,
            category: b.category,
            customerName: b.customer_name,
            phone: b.phone || '',
            route: b.route || '',
            status: b.status,
            cancelReason: b.cancel_reason,
            createdAt: b.created_at,
            updatedAt: b.updated_at,
            cancelledAt: b.cancelled_at
          }));
          
          setBookings(formattedData);
        } catch (error) {
          console.error('Failed to load bookings:', error);
        }
        setLoading(false);
      };

      const saveBooking = async (booking, isUpdate = false) => {
        try {
          const dbData = {
            id: booking.id,
            venue: booking.venue,
            court: booking.court,
            date: booking.date,
            start_time: booking.startTime,
            end_time: booking.endTime,
            category: booking.category,
            customer_name: booking.customerName,
            phone: booking.phone || null,
            route: booking.route || null,
            status: booking.status,
            cancel_reason: booking.cancelReason || null,
            updated_at: isUpdate ? new Date().toISOString() : null,
            cancelled_at: booking.cancelledAt || null
          };

          if (isUpdate) {
            const { error } = await db
              .from('bookings')
              .update(dbData)
              .eq('id', booking.id);
            if (error) throw error;
          } else {
            const { error } = await db
              .from('bookings')
              .insert(dbData);
            if (error) throw error;
          }
          
          await loadBookings();
          return true;
        } catch (error) {
          console.error('Failed to save booking:', error);
          alert('저장에 실패했습니다.');
          return false;
        }
      };

      const checkTimeOverlap = (booking, excludeId = null) => {
        const timeToMinutes = (time) => {
          const [h, m] = time.split(':').map(Number);
          return h * 60 + m;
        };
        const newStart = timeToMinutes(booking.startTime);
        const newEnd = timeToMinutes(booking.endTime);
        return bookings.find(b => {
          if (b.id === excludeId || b.status === 'cancelled' || b.date !== booking.date || b.venue !== booking.venue || b.court !== booking.court) return false;
          const existingStart = timeToMinutes(b.startTime);
          const existingEnd = timeToMinutes(b.endTime);
          return (newStart < existingEnd && newEnd > existingStart);
        });
      };

      const addBooking = async () => {
        if (!newBooking.date || !newBooking.customerName) { setRequiredAlert(true); return; }
        const overlapping = checkTimeOverlap(newBooking, editingBookingId);
        if (overlapping) { setOverlapAlert(overlapping); return; }
        const bookingData = { ...newBooking, id: isEditMode ? editingBookingId : Date.now() };
        const success = await saveBooking(bookingData, isEditMode);
        if (success) {
          setShowModal(false);
          setIsEditMode(false);
          setEditingBookingId(null);
          setNewBooking({ venue: '세마', court: '단일구장', date: '', startTime: '06:00', endTime: '08:00', category: '대관', customerName: '', phone: '', route: '전화', status: 'active' });
        }
      };

      const openEditModal = (booking) => {
        setSelectedBooking(null);
        setIsEditMode(true);
        setEditingBookingId(booking.id);
        setNewBooking({ venue: booking.venue, court: booking.court, date: booking.date, startTime: booking.startTime, endTime: booking.endTime, category: booking.category, customerName: booking.customerName, phone: booking.phone || '', route: booking.route || '전화', status: booking.status });
        setShowModal(true);
      };

      const calculateEndTime = (startTime) => {
        const [h, m] = startTime.split(':').map(Number);
        return `${String(h + 2).padStart(2, '0')}:${String(m).padStart(2, '0')}`;
      };

      const cancelBooking = async (id, reason) => {
        const booking = bookings.find(b => b.id === id);
        if (booking) {
          await saveBooking({ ...booking, status: 'cancelled', cancelReason: reason, cancelledAt: new Date().toISOString() }, true);
        }
        setSelectedBooking(null);
        setShowCancelModal(null);
        setCancelReason('');
      };

      const deleteBooking = async () => {
        if (deletePassword === '1818') {
          try {
            const { error } = await db.from('bookings').delete().eq('id', deleteId);
            if (error) throw error;
            await loadBookings();
            setDeleteId(null);
            setDeletePassword('');
            setShowDetailModal(false);
            alert('삭제되었습니다.');
          } catch (error) {
            alert('삭제에 실패했습니다.');
          }
        } else {
          alert('비밀번호가 올바르지 않습니다.');
        }
      };

      const handleCategoryChange = (category) => {
        if (category === '소셜매치') setNewBooking({ ...newBooking, category, customerName: '플랩풋볼', phone: '', route: '소셜' });
        else if (category === '아카데미') setNewBooking({ ...newBooking, category, customerName: '', route: '' });
        else setNewBooking({ ...newBooking, category, customerName: '', route: '전화' });
      };

      const openDateModal = (date) => {
        if (selectedVenue === '전체') { alert('예약을 추가하려면 특정 구장을 선택해주세요.'); return; }
        const dateStr = `${date.getFullYear()}-${String(date.getMonth() + 1).padStart(2, '0')}-${String(date.getDate()).padStart(2, '0')}`;
        setIsEditMode(false);
        setNewBooking({ venue: selectedVenue, court: selectedCourt, date: dateStr, startTime: '06:00', endTime: '08:00', category: '대관', customerName: '', phone: '', route: '전화', status: 'active' });
        setShowModal(true);
      };

      const showCategoryDetail = (category, period, isAllVenues = false) => {
        let filtered = [];
        if (period === 'custom') {
          const start = new Date(customDateRange.start);
          const end = new Date(customDateRange.end);
          end.setHours(23, 59, 59, 999);
          filtered = bookings.filter(b => { const d = new Date(b.date); return d >= start && d <= end; });
        }
        if (!isAllVenues && selectedVenue !== '전체') {
          filtered = filtered.filter(b => {
            if (b.venue !== selectedVenue) return false;
            if ((selectedVenue === '세마' || selectedVenue === '춘의') && selectedCourt === '단일구장') return b.court === '단일구장' || b.court === '1구장';
            return b.court === selectedCourt;
          });
        }
        if (category === 'total') { setDetailData(filtered.filter(b => b.status === 'active')); setDetailTitle(`진행${isAllVenues ? ' - 전체 구장' : ''}`); }
        else if (category === 'cancelled') { setDetailData(filtered.filter(b => b.status === 'cancelled')); setDetailTitle(`취소 내역${isAllVenues ? ' - 전체 구장' : ''}`); }
        else { setDetailData(filtered.filter(b => b.category === category && b.status === 'active')); setDetailTitle(`${category}${isAllVenues ? ' - 전체 구장' : ''}`); }
        setShowDetailModal(true);
      };

      const getDayBookings = (date) => {
        const dateStr = `${date.getFullYear()}-${String(date.getMonth() + 1).padStart(2, '0')}-${String(date.getDate()).padStart(2, '0')}`;
        if (selectedVenue === '전체') return bookings.filter(b => b.date === dateStr).sort((a, b) => a.startTime.localeCompare(b.startTime));
        return bookings.filter(b => {
          if (b.date !== dateStr || b.venue !== selectedVenue) return false;
          if ((selectedVenue === '세마' || selectedVenue === '춘의') && selectedCourt === '단일구장') return b.court === '단일구장' || b.court === '1구장';
          return b.court === selectedCourt;
        }).sort((a, b) => a.startTime.localeCompare(b.startTime));
      };

      const getStats = (period, isAllVenues = false) => {
        let filtered = [];
        if (period === 'custom') {
          const start = new Date(customDateRange.start);
          const end = new Date(customDateRange.end);
          end.setHours(23, 59, 59, 999);
          filtered = bookings.filter(b => { const d = new Date(b.date); return d >= start && d <= end; });
        }
        if (!isAllVenues && selectedVenue !== '전체') {
          filtered = filtered.filter(b => {
            if (b.venue !== selectedVenue) return false;
            if ((selectedVenue === '세마' || selectedVenue === '춘의') && selectedCourt === '단일구장') return b.court === '단일구장' || b.court === '1구장';
            return b.court === selectedCourt;
          });
        }
        const active = filtered.filter(b => b.status === 'active');
        const cancelled = filtered.filter(b => b.status === 'cancelled');
        return {
          total: active.length, cancelled: cancelled.length,
          cancelledByCategory: { '대관': cancelled.filter(b => b.category === '대관').length, '소셜매치': cancelled.filter(b => b.category === '소셜매치').length, '아카데미': cancelled.filter(b => b.category === '아카데미').length },
          categoryStats: { '대관': active.filter(b => b.category === '대관').length, '소셜매치': active.filter(b => b.category === '소셜매치').length, '아카데미': active.filter(b => b.category === '아카데미').length }
        };
      };

      const renderCalendar = () => {
        const year = currentDate.getFullYear(), month = currentDate.getMonth();
        const daysInMonth = new Date(year, month + 1, 0).getDate();
        const startingDay = new Date(year, month, 1).getDay();
        const days = [];
        for (let i = 0; i < startingDay; i++) days.push(<div key={`e${i}`} className="min-h-20 border-b border-r bg-gray-50"></div>);
        for (let day = 1; day <= daysInMonth; day++) {
          const date = new Date(year, month, day);
          const dayBookings = getDayBookings(date);
          const isToday = date.toDateString() === new Date().toDateString();
          const formatName = (name) => { if (name === '플랩풋볼') return '플랩'; return name.length > 3 ? name.slice(0, 3) + '..' : name; };
          days.push(
            <div key={day} className={`min-h-20 border-b border-r p-0.5 overflow-y-auto cursor-pointer active:bg-gray-100 ${isToday ? 'bg-blue-50' : 'bg-white'}`} onClick={() => openDateModal(date)}>
              <div className={`text-[11px] font-semibold mb-0.5 ${isToday ? 'text-blue-600' : 'text-gray-700'}`}>{day}</div>
              <div className="space-y-0.5">
                {dayBookings.map(b => (
                  <div key={b.id} className={`text-[8px] leading-tight px-0.5 py-0.5 rounded ${categories[b.category]} ${b.status === 'cancelled' ? 'opacity-30 line-through' : ''} text-white cursor-pointer active:opacity-80`} onClick={(e) => { e.stopPropagation(); setSelectedBooking(b); }}>
                    <div>{b.startTime.split(':')[0]}시 {formatName(b.customerName)}</div>
                  </div>
                ))}
              </div>
            </div>
          );
        }
        return days;
      };

      const StatCard = ({ title, value, period, category, bgColor, isAllVenues, cancelledByCategory, stats }) => (
        <div className={`${bgColor} p-4 rounded-xl cursor-pointer`} onClick={() => showCategoryDetail(category, period, isAllVenues)}>
          <div className="text-sm text-gray-600 mb-1">{title}</div>
          <div className="text-2xl font-bold mb-2">{value}건</div>
          {category === 'total' && stats && (
            <div className="mt-3 pt-3 border-t border-gray-300 space-y-2">
              <div className="flex justify-between"><span className="text-sm text-gray-700">대관</span><span className="font-bold text-blue-600">{stats.categoryStats['대관']}건</span></div>
              <div className="flex justify-between"><span className="text-sm text-gray-700">소셜매치</span><span className="font-bold text-green-600">{stats.categoryStats['소셜매치']}건</span></div>
              <div className="flex justify-between"><span className="text-sm text-gray-700">아카데미</span><span className="font-bold text-purple-600">{stats.categoryStats['아카데미']}건</span></div>
            </div>
          )}
          {category === 'cancelled' && cancelledByCategory && (
            <div className="mt-3 pt-3 border-t border-gray-300 space-y-2">
              <div className="flex justify-between"><span className="text-sm text-gray-700">대관</span><span className="font-bold text-red-600">{cancelledByCategory['대관']}건</span></div>
              <div className="flex justify-between"><span className="text-sm text-gray-700">소셜매치</span><span className="font-bold text-red-600">{cancelledByCategory['소셜매치']}건</span></div>
              <div className="flex justify-between"><span className="text-sm text-gray-700">아카데미</span><span className="font-bold text-red-600">{cancelledByCategory['아카데미']}건</span></div>
            </div>
          )}
        </div>
      );

      if (loading) {
        return (
          <div className="min-h-screen bg-gray-50 flex items-center justify-center">
            <div className="text-center">
              <div className="w-8 h-8 border-4 border-blue-500 border-t-transparent rounded-full animate-spin mx-auto mb-2"></div>
              <p className="text-gray-600">로딩 중...</p>
            </div>
          </div>
        );
      }

      if (view === 'list') {
        const filtered = bookings.filter(b => {
          if (b.status !== 'active') return false;
          if (listVenue !== '전체' && b.venue !== listVenue) return false;
          if (searchQuery.trim() && !b.customerName.includes(searchQuery.trim()) && !(b.phone && b.phone.includes(searchQuery.trim()))) return false;
          return true;
        }).sort((a, b) => new Date(b.date) - new Date(a.date));
        const displayed = filtered.slice(0, displayCount);
        
        return (
          <div className="min-h-screen bg-gray-50">
            <div className="max-w-2xl mx-auto">
              <div className="bg-white border-b sticky top-0 z-10 p-4">
                <div className="flex items-center justify-between mb-3">
                  <button onClick={() => setView('calendar')} className="p-2 rounded-full"><CalendarIcon size={20} className="text-blue-500" /></button>
                  <h1 className="text-xl font-bold">대관 내역</h1>
                  <button onClick={() => setView('stats')} className="p-2 rounded-full"><BarChartIcon size={20} className="text-blue-500" /></button>
                </div>
                <select value={listVenue} onChange={(e) => { setListVenue(e.target.value); setDisplayCount(20); }} className="w-full border rounded-lg px-3 py-2 text-sm mb-3">
                  <option value="전체">전체 구장</option>
                  {Object.keys(venues).map(v => <option key={v} value={v}>{v}</option>)}
                </select>
                <input type="text" placeholder="이름 또는 연락처 검색" value={searchQuery} onChange={(e) => { setSearchQuery(e.target.value); setDisplayCount(20); }} className="w-full border rounded-lg px-3 py-2 text-sm" />
              </div>
              <div className="p-4">
                <div className="bg-white rounded-xl shadow">
                  {displayed.length === 0 ? <p className="text-gray-500 text-center py-8">대관 내역이 없습니다.</p> : (
                    <>
                      <div className="divide-y">
                        {displayed.map(b => (
                          <div key={b.id} className="p-4 cursor-pointer" onClick={() => setSelectedBooking(b)}>
                            <div className="flex justify-between items-start mb-2">
                              <div><div className="font-semibold">{b.customerName}</div><div className="text-sm text-gray-600">{b.venue} {b.court}</div></div>
                              <div className="text-sm text-gray-600">{b.date}</div>
                            </div>
                            <div className="flex justify-between text-sm text-gray-600">
                              <span>{b.startTime} - {b.endTime}</span><span>{b.phone || '-'}</span>
                            </div>
                          </div>
                        ))}
                      </div>
                      {filtered.length > displayCount && (
                        <div className="p-4 border-t">
                          <button onClick={() => setDisplayCount(displayCount + 20)} className="w-full bg-blue-500 text-white py-3 rounded-lg font-semibold">더보기 ({displayCount}/{filtered.length})</button>
                        </div>
                      )}
                    </>
                  )}
                </div>
              </div>
            </div>
            {selectedBooking && (
              <div className="fixed inset-0 bg-black bg-opacity-50 flex items-end z-50">
                <div className="bg-white rounded-t-3xl w-full max-w-2xl mx-auto">
                  <div className="p-4 border-b flex justify-between items-center">
                    <h3 className="text-lg font-bold">예약 상세</h3>
                    <button onClick={() => setSelectedBooking(null)}><XIcon size={24} /></button>
                  </div>
                  <div className="p-4 space-y-2">
                    <p><span className="text-gray-600">구장:</span> {selectedBooking.venue} {selectedBooking.court}</p>
                    <p><span className="text-gray-600">날짜:</span> {selectedBooking.date}</p>
                    <p><span className="text-gray-600">시간:</span> {selectedBooking.startTime} - {selectedBooking.endTime}</p>
                    <p><span className="text-gray-600">카테고리:</span> {selectedBooking.category}</p>
                    <p><span className="text-gray-600">예약자:</span> {selectedBooking.customerName}</p>
                    <p><span className="text-gray-600">연락처:</span> {selectedBooking.phone || '-'}</p>
                    <p><span className="text-gray-600">예약 루트:</span> {selectedBooking.route || '-'}</p>
                  </div>
                </div>
              </div>
            )}
          </div>
        );
      }

      if (view === 'stats') {
        const custom = customDateRange.start && customDateRange.end ? getStats('custom', selectedVenue === '전체') : null;
        return (
          <div className="min-h-screen bg-gray-50">
            <div className="max-w-2xl mx-auto">
              <div className="bg-white border-b sticky top-0 z-10 p-4">
                <div className="flex items-center justify-between mb-3">
                  <div className="flex gap-2">
                    <button onClick={() => setView('calendar')} className="p-2 rounded-full"><CalendarIcon size={20} className="text-blue-500" /></button>
                    <button onClick={() => setView('list')} className="p-2 rounded-full"><ListIcon size={20} className="text-blue-500" /></button>
                  </div>
                  <h1 className="text-xl font-bold">지표</h1>
                  <div className="w-20"></div>
                </div>
                <div className="flex gap-2 mb-2">
                  <select value={selectedVenue} onChange={(e) => { setSelectedVenue(e.target.value); if (e.target.value !== '전체') setSelectedCourt(venues[e.target.value][0]); }} className="flex-1 border rounded-lg px-3 py-2 text-sm">
                    <option value="전체">전체 구장</option>
                    {Object.keys(venues).map(v => <option key={v} value={v}>{v}</option>)}
                  </select>
                  {selectedVenue !== '전체' && (
                    <select value={selectedCourt} onChange={(e) => setSelectedCourt(e.target.value)} className="flex-1 border rounded-lg px-3 py-2 text-sm">
                      {venues[selectedVenue].map(c => <option key={c} value={c}>{c}</option>)}
                    </select>
                  )}
                </div>
              </div>
              <div className="p-3">
                <div className="bg-white p-3 rounded-xl shadow">
                  <div className="space-y-2">
                    <div className="flex items-center gap-2">
                      <label className="text-xs text-gray-500 w-8">시작</label>
                      <input type="date" value={customDateRange.start} onChange={(e) => setCustomDateRange({...customDateRange, start: e.target.value})} className="flex-1 border rounded px-2 py-1.5 text-sm" />
                    </div>
                    <div className="flex items-center gap-2">
                      <label className="text-xs text-gray-500 w-8">종료</label>
                      <input type="date" value={customDateRange.end} onChange={(e) => setCustomDateRange({...customDateRange, end: e.target.value})} className="flex-1 border rounded px-2 py-1.5 text-sm" />
                    </div>
                  </div>
                  {custom && (
                    <div className="grid grid-cols-2 gap-2 mt-3">
                      <StatCard title="진행" value={custom.total} period="custom" category="total" bgColor="bg-blue-50" isAllVenues={selectedVenue === '전체'} cancelledByCategory={custom.cancelledByCategory} stats={custom} />
                      <StatCard title="취소" value={custom.cancelled} period="custom" category="cancelled" bgColor="bg-red-50" isAllVenues={selectedVenue === '전체'} cancelledByCategory={custom.cancelledByCategory} />
                    </div>
                  )}
                </div>
              </div>
            </div>
            {showDetailModal && (
              <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 z-50" onClick={() => setShowDetailModal(false)}>
                <div className="bg-white rounded-2xl w-full max-w-2xl max-h-[70vh] flex flex-col" onClick={(e) => e.stopPropagation()}>
                  <div className="border-b p-4 flex justify-between items-center">
                    <h3 className="text-lg font-bold">{detailTitle}</h3>
                    <button onClick={() => setShowDetailModal(false)}><XIcon size={24} /></button>
                  </div>
                  <div className="p-4 space-y-3 overflow-y-auto flex-1">
                    {detailData.length === 0 ? <p className="text-gray-500 text-center py-8">데이터가 없습니다.</p> : 
                      detailData.map(b => (
                        <div key={b.id} className="bg-gray-50 rounded-xl p-4">
                          <div className="grid grid-cols-2 gap-2 text-sm">
                            <p><span className="text-gray-600">구장:</span> {b.venue} {b.court}</p>
                            <p><span className="text-gray-600">날짜:</span> {b.date}</p>
                            <p><span className="text-gray-600">예약자:</span> {b.customerName}</p>
                            <p><span className="text-gray-600">카테고리:</span> {b.category}</p>
                            <p><span className="text-gray-600">시간:</span> {b.startTime}-{b.endTime}</p>
                            <p><span className="text-gray-600">유입:</span> {b.route || '-'}</p>
                            <p className="col-span-2"><span className="text-gray-600">연락처:</span> {b.phone || '-'}</p>
                            {b.cancelReason && <p className="col-span-2"><span className="text-gray-600">취소사유:</span> {b.cancelReason}</p>}
                          </div>
                          {detailTitle.includes('취소') && (
                            <button onClick={() => setDeleteId(b.id)} className="mt-2 bg-red-500 text-white px-4 py-2 rounded-lg text-sm flex items-center gap-2">
                              <TrashIcon size={16} /> 삭제
                            </button>
                          )}
                        </div>
                      ))
                    }
                  </div>
                </div>
              </div>
            )}
            {deleteId && (
              <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 z-50">
                <div className="bg-white rounded-2xl p-6 max-w-sm w-full">
                  <h3 className="text-lg font-bold mb-4">예약 삭제</h3>
                  <p className="mb-4 text-sm text-gray-600">비밀번호를 입력하세요.</p>
                  <input type="password" value={deletePassword} onChange={(e) => setDeletePassword(e.target.value)} className="w-full border rounded-lg px-4 py-3 mb-4" placeholder="비밀번호" />
                  <div className="flex gap-2">
                    <button onClick={deleteBooking} className="flex-1 bg-red-500 text-white py-3 rounded-lg font-semibold">삭제</button>
                    <button onClick={() => { setDeleteId(null); setDeletePassword(''); }} className="flex-1 bg-gray-200 py-3 rounded-lg font-semibold">취소</button>
                  </div>
                </div>
              </div>
            )}
          </div>
        );
      }

      return (
        <div className="min-h-screen bg-gray-50">
          <div className="max-w-2xl mx-auto">
            <div className="bg-white border-b">
              <div className="p-4">
                <div className="flex items-center justify-between mb-4">
                  <button onClick={loadBookings} className="p-2 rounded-full"><RefreshIcon size={20} className="text-blue-500" /></button>
                  <h1 className="text-xl font-bold">예약관리</h1>
                  <div className="flex gap-2">
                    <button onClick={() => setView('list')} className="p-2 rounded-full"><ListIcon size={24} className="text-blue-500" /></button>
                    <button onClick={() => setView('stats')} className="p-2 rounded-full"><BarChartIcon size={24} className="text-blue-500" /></button>
                  </div>
                </div>
                <div className="flex gap-2">
                  <select value={selectedVenue} onChange={(e) => { setSelectedVenue(e.target.value); if (e.target.value !== '전체') setSelectedCourt(venues[e.target.value][0]); }} className="flex-1 border rounded-lg px-3 py-2 text-sm">
                    <option value="전체">전체 구장</option>
                    {Object.keys(venues).map(v => <option key={v} value={v}>{v}</option>)}
                  </select>
                  {selectedVenue !== '전체' && (
                    <select value={selectedCourt} onChange={(e) => setSelectedCourt(e.target.value)} className="flex-1 border rounded-lg px-3 py-2 text-sm">
                      {venues[selectedVenue].map(c => <option key={c} value={c}>{c}</option>)}
                    </select>
                  )}
                </div>
              </div>
              <div className="px-4 pb-3 flex items-center justify-between">
                <button onClick={() => setCurrentDate(new Date(currentDate.getFullYear(), currentDate.getMonth() - 1))} className="text-blue-500 font-medium text-sm">이전</button>
                <h2 className="text-base font-bold">{currentDate.getFullYear()}년 {currentDate.getMonth() + 1}월</h2>
                <button onClick={() => setCurrentDate(new Date(currentDate.getFullYear(), currentDate.getMonth() + 1))} className="text-blue-500 font-medium text-sm">다음</button>
              </div>
              <div className="grid grid-cols-7 border-t">
                {['일', '월', '화', '수', '목', '금', '토'].map((d, i) => <div key={d} className={`text-center text-xs font-semibold py-2 border-r ${i === 0 ? 'text-red-500' : i === 6 ? 'text-blue-500' : 'text-gray-600'}`}>{d}</div>)}
              </div>
            </div>
            <div className="grid grid-cols-7 border-l">{renderCalendar()}</div>
            <div className="p-4 flex gap-3 bg-white border-t">
              {Object.entries(categories).map(([cat, color]) => (<div key={cat} className="flex items-center gap-1.5"><div className={`w-3 h-3 ${color} rounded-full`}></div><span className="text-xs text-gray-600">{cat}</span></div>))}
            </div>
          </div>

          {showModal && (
            <div className="fixed inset-0 bg-black bg-opacity-50 flex items-end z-50">
              <div className="bg-white rounded-t-3xl w-full max-w-2xl mx-auto max-h-[90vh] overflow-y-auto">
                <div className="sticky top-0 bg-white border-b p-4 flex justify-between items-center">
                  <button onClick={() => { setShowModal(false); setIsEditMode(false); setEditingBookingId(null); setNewBooking({ venue: '세마', court: '단일구장', date: '', startTime: '06:00', endTime: '08:00', category: '대관', customerName: '', phone: '', route: '전화', status: 'active' }); }} className="text-blue-500 font-medium">취소</button>
                  <h3 className="text-lg font-bold">{isEditMode ? '예약 수정' : '새 예약'}</h3>
                  <button onClick={addBooking} className="text-blue-500 font-medium">완료</button>
                </div>
                <div className="p-4 space-y-4">
                  <div className="grid grid-cols-2 gap-3">
                    <div><label className="block text-sm font-medium mb-1.5">구장</label><select value={newBooking.venue} onChange={(e) => setNewBooking({...newBooking, venue: e.target.value, court: venues[e.target.value][0]})} className="w-full border rounded-lg px-3 py-2.5">{Object.keys(venues).map(v => <option key={v} value={v}>{v}</option>)}</select></div>
                    <div><label className="block text-sm font-medium mb-1.5">코트</label><select value={newBooking.court} onChange={(e) => setNewBooking({...newBooking, court: e.target.value})} className="w-full border rounded-lg px-3 py-2.5">{venues[newBooking.venue].map(c => <option key={c} value={c}>{c}</option>)}</select></div>
                  </div>
                  <div><label className="block text-sm font-medium mb-1.5">날짜 *</label><input type="date" value={newBooking.date} onChange={(e) => setNewBooking({...newBooking, date: e.target.value})} className="w-full border rounded-lg px-3 py-2.5" /></div>
                  <div className="grid grid-cols-2 gap-3">
                    <div><label className="block text-sm font-medium mb-1.5">시작</label><select value={newBooking.startTime} onChange={(e) => setNewBooking({...newBooking, startTime: e.target.value, endTime: calculateEndTime(e.target.value)})} className="w-full border rounded-lg px-3 py-2.5">{timeSlots.map(t => <option key={t} value={t}>{t}</option>)}</select></div>
                    <div><label className="block text-sm font-medium mb-1.5">종료</label><select value={newBooking.endTime} onChange={(e) => setNewBooking({...newBooking, endTime: e.target.value})} className="w-full border rounded-lg px-3 py-2.5">{timeSlots.map(t => <option key={t} value={t}>{t}</option>)}</select></div>
                  </div>
                  <div><label className="block text-sm font-medium mb-1.5">카테고리</label><select value={newBooking.category} onChange={(e) => handleCategoryChange(e.target.value)} className="w-full border rounded-lg px-3 py-2.5">{Object.keys(categories).map(c => <option key={c} value={c}>{c}</option>)}</select></div>
                  <div><label className="block text-sm font-medium mb-1.5">예약자명 * {newBooking.category === '소셜매치' && <span className="text-xs text-gray-500">(자동: 플랩풋볼)</span>}</label><input type="text" value={newBooking.customerName} onChange={(e) => setNewBooking({...newBooking, customerName: e.target.value})} disabled={newBooking.category === '소셜매치'} className="w-full border rounded-lg px-3 py-2.5 disabled:bg-gray-100" placeholder="홍길동" /></div>
                  <div><label className="block text-sm font-medium mb-1.5">연락처 <span className="text-xs text-gray-500">(선택사항)</span></label><input type="tel" value={newBooking.phone} onChange={(e) => setNewBooking({...newBooking, phone: e.target.value.replace(/[^0-9]/g, '')})} className="w-full border rounded-lg px-3 py-2.5" placeholder="01012345678" inputMode="numeric" /></div>
                  {newBooking.category !== '소셜매치' && newBooking.category !== '아카데미' && (<div><label className="block text-sm font-medium mb-1.5">예약 루트</label><select value={newBooking.route} onChange={(e) => setNewBooking({...newBooking, route: e.target.value})} className="w-full border rounded-lg px-3 py-2.5"><option value="전화">전화</option><option value="문자">문자</option><option value="카카오톡채널">카카오톡채널</option><option value="네이버대관">네이버대관</option><option value="플랩대관">플랩대관</option></select></div>)}
                  {newBooking.category === '소셜매치' && (<div><label className="block text-sm font-medium mb-1.5">예약 루트</label><input type="text" value="소셜" disabled className="w-full border rounded-lg px-3 py-2.5 bg-gray-100" /></div>)}
                </div>
              </div>
            </div>
          )}

          {selectedBooking && (
            <div className="fixed inset-0 bg-black bg-opacity-50 flex items-end z-50">
              <div className="bg-white rounded-t-3xl w-full max-w-2xl mx-auto">
                <div className="p-4 border-b flex justify-between items-center">
                  <h3 className="text-lg font-bold">예약 상세</h3>
                  <button onClick={() => setSelectedBooking(null)}><XIcon size={24} /></button>
                </div>
                <div className="p-4 space-y-2">
                  <p><span className="text-gray-600">구장:</span> {selectedBooking.venue} {selectedBooking.court}</p>
                  <p><span className="text-gray-600">날짜:</span> {selectedBooking.date}</p>
                  <p><span className="text-gray-600">시간:</span> {selectedBooking.startTime} - {selectedBooking.endTime}</p>
                  <p><span className="text-gray-600">카테고리:</span> {selectedBooking.category}</p>
                  <p><span className="text-gray-600">예약자:</span> {selectedBooking.customerName}</p>
                  <p><span className="text-gray-600">연락처:</span> {selectedBooking.phone || '-'}</p>
                  <p><span className="text-gray-600">예약 루트:</span> {selectedBooking.route || '-'}</p>
                  <p><span className="text-gray-600">상태:</span> {selectedBooking.status === 'active' ? '활성' : '취소됨'}</p>
                </div>
                {selectedBooking.status === 'active' && (
                  <div className="p-4 border-t flex gap-3">
                    <button onClick={() => openEditModal(selectedBooking)} className="flex-1 bg-blue-500 text-white py-3 rounded-lg font-semibold flex items-center justify-center gap-2"><EditIcon size={18} /> 예약 수정</button>
                    <button onClick={() => { setShowCancelModal(selectedBooking); setSelectedBooking(null); }} className="flex-1 bg-red-500 text-white py-3 rounded-lg font-semibold flex items-center justify-center gap-2"><XIcon size={18} /> 예약 취소</button>
                  </div>
                )}
              </div>
            </div>
          )}

          {overlapAlert && (
            <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 z-50">
              <div className="bg-white rounded-2xl p-6 max-w-sm w-full">
                <h3 className="text-lg font-bold mb-4 text-red-500">예약 불가</h3>
                <p className="mb-2 text-sm text-gray-600">해당 시간에 이미 예약이 있습니다.</p>
                <div className="bg-gray-100 rounded-lg p-3 mb-4">
                  <p className="text-sm"><span className="text-gray-600">예약자:</span> {overlapAlert.customerName}</p>
                  <p className="text-sm"><span className="text-gray-600">시간:</span> {overlapAlert.startTime} - {overlapAlert.endTime}</p>
                </div>
                <button onClick={() => setOverlapAlert(null)} className="w-full bg-blue-500 text-white py-3 rounded-lg font-semibold">확인</button>
              </div>
            </div>
          )}

          {showCancelModal && (
            <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 z-50">
              <div className="bg-white rounded-2xl p-6 max-w-sm w-full">
                <h3 className="text-lg font-bold mb-4">예약 취소</h3>
                <p className="mb-2 text-sm text-gray-600">취소 사유를 입력해주세요.</p>
                <textarea value={cancelReason} onChange={(e) => setCancelReason(e.target.value)} className="w-full border rounded-lg px-4 py-3 mb-4 h-24 resize-none" placeholder="취소 사유 입력" />
                <div className="flex gap-2">
                  <button onClick={() => cancelBooking(showCancelModal.id, cancelReason)} className="flex-1 bg-red-500 text-white py-3 rounded-lg font-semibold">취소 확인</button>
                  <button onClick={() => { setShowCancelModal(null); setCancelReason(''); }} className="flex-1 bg-gray-200 py-3 rounded-lg font-semibold">닫기</button>
                </div>
              </div>
            </div>
          )}

          {requiredAlert && (
            <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 z-50">
              <div className="bg-white rounded-2xl p-6 max-w-sm w-full">
                <h3 className="text-lg font-bold mb-4 text-red-500">입력 오류</h3>
                <p className="mb-4 text-sm text-gray-600">필수값이 입력되지 않았습니다.<br/>날짜와 예약자명을 확인해주세요.</p>
                <button onClick={() => setRequiredAlert(false)} className="w-full bg-blue-500 text-white py-3 rounded-lg font-semibold">확인</button>
              </div>
            </div>
          )}
        </div>
      );
    };

    ReactDOM.createRoot(document.getElementById('root')).render(<FutsalBookingSystem />);
  </script>
</body>
</html>
