<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <meta name="mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="default">
  <meta name="apple-mobile-web-app-title" content="í’‹ì‚´ê³µê°„">
  <title>í’‹ì‚´ê³µê°„ ì˜ˆì•½ê´€ë¦¬</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
  <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <style>
    body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; }
    * { -webkit-tap-highlight-color: transparent; box-sizing: border-box; }
    html, body { touch-action: manipulation; -webkit-overflow-scrolling: touch; }
    input, select, textarea { font-size: 16px !important; }
    input[type="date"] { min-height: 36px; }
  </style>
</head>
<body>
  <div id="root"></div>
  <script type="text/babel">
    const { useState, useEffect } = React;

    const Icon = ({ children, size = 24, className = "" }) => (
      <svg xmlns="http://www.w3.org/2000/svg" width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}>{children}</svg>
    );
    const CalendarIcon = ({ size, className }) => <Icon size={size} className={className}><rect x="3" y="4" width="18" height="18" rx="2" ry="2"/><line x1="16" y1="2" x2="16" y2="6"/><line x1="8" y1="2" x2="8" y2="6"/><line x1="3" y1="10" x2="21" y2="10"/></Icon>;
    const XIcon = ({ size, className }) => <Icon size={size} className={className}><line x1="18" y1="6" x2="6" y2="18"/><line x1="6" y1="6" x2="18" y2="18"/></Icon>;
    const BarChartIcon = ({ size, className }) => <Icon size={size} className={className}><line x1="12" y1="20" x2="12" y2="10"/><line x1="18" y1="20" x2="18" y2="4"/><line x1="6" y1="20" x2="6" y2="16"/></Icon>;
    const ListIcon = ({ size, className }) => <Icon size={size} className={className}><line x1="8" y1="6" x2="21" y2="6"/><line x1="8" y1="12" x2="21" y2="12"/><line x1="8" y1="18" x2="21" y2="18"/><line x1="3" y1="6" x2="3.01" y2="6"/><line x1="3" y1="12" x2="3.01" y2="12"/><line x1="3" y1="18" x2="3.01" y2="18"/></Icon>;
    const EditIcon = ({ size, className }) => <Icon size={size} className={className}><path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"/><path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"/></Icon>;
    const TrashIcon = ({ size, className }) => <Icon size={size} className={className}><polyline points="3 6 5 6 21 6"/><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"/></Icon>;
    const RefreshIcon = ({ size, className }) => <Icon size={size} className={className}><polyline points="23 4 23 10 17 10"/><path d="M20.49 15a9 9 0 1 1-2.12-9.36L23 10"/></Icon>;
    const RepeatIcon = ({ size, className }) => <Icon size={size} className={className}><polyline points="17 1 21 5 17 9"/><path d="M3 11V9a4 4 0 0 1 4-4h14"/><polyline points="7 23 3 19 7 15"/><path d="M21 13v2a4 4 0 0 1-4 4H3"/></Icon>;

    const SUPABASE_URL = 'https://ltkjopawqjdzoqegbkaz.supabase.co';
    const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Imx0a2pvcGF3cWpkem9xZWdia2F6Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjkwOTk2MjksImV4cCI6MjA4NDY3NTYyOX0.BknFqHiwMn2hxo_FRNbwMW3V-anq-EzpsUdhmb_cJw0';
    const db = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

    const FutsalBookingSystem = () => {
      const [selectedVenue, setSelectedVenue] = useState('ì„¸ë§ˆ');
      const [selectedCourt, setSelectedCourt] = useState('ë‹¨ì¼êµ¬ì¥');
      const [currentDate, setCurrentDate] = useState(new Date());
      const [view, setView] = useState('calendar');
      const [bookings, setBookings] = useState([]);
      const [loading, setLoading] = useState(true);
      const [showModal, setShowModal] = useState(false);
      const [showDetailModal, setShowDetailModal] = useState(false);
      const [selectedBooking, setSelectedBooking] = useState(null);
      const [detailData, setDetailData] = useState([]);
      const [detailTitle, setDetailTitle] = useState('');
      const [deleteId, setDeleteId] = useState(null);
      const [deletePassword, setDeletePassword] = useState('');
      const [isEditMode, setIsEditMode] = useState(false);
      const [overlapAlert, setOverlapAlert] = useState(null);
      const [showCancelModal, setShowCancelModal] = useState(null);
      const [cancelReason, setCancelReason] = useState('');
      const [requiredAlert, setRequiredAlert] = useState(false);
      const [newBooking, setNewBooking] = useState({
        venue: 'ì„¸ë§ˆ', court: 'ë‹¨ì¼êµ¬ì¥', date: '', startTime: '06:00', endTime: '08:00',
        category: 'ëŒ€ê´€', customerName: '', phone: '', route: 'ì „í™”', status: 'active'
      });
      const [customDateRange, setCustomDateRange] = useState({ start: '', end: '' });
      const [searchQuery, setSearchQuery] = useState('');
      const [listVenue, setListVenue] = useState('ì „ì²´');
      const [displayCount, setDisplayCount] = useState(20);
      const [editingBookingId, setEditingBookingId] = useState(null);
      
      // ë°˜ë³µ ì˜ˆì•½ ê´€ë ¨ ìƒíƒœ
      const [isRepeatMode, setIsRepeatMode] = useState(false);
      const [repeatDays, setRepeatDays] = useState([]);
      const [repeatEndDate, setRepeatEndDate] = useState('');
      const [showBulkCancelModal, setShowBulkCancelModal] = useState(null);
      const [bulkCancelConfirm, setBulkCancelConfirm] = useState(false);

      const venues = { 'ì„¸ë§ˆ': ['ë‹¨ì¼êµ¬ì¥'], 'êµ°í¬': ['1êµ¬ì¥', '2êµ¬ì¥'], 'ì¶˜ì˜': ['ë‹¨ì¼êµ¬ì¥'] };
      const categories = { 'ëŒ€ê´€': 'bg-green-500', 'ì†Œì…œë§¤ì¹˜': 'bg-blue-500', 'ì•„ì¹´ë°ë¯¸': 'bg-purple-500' };
      const timeSlots = Array.from({length: 48}, (_, i) => `${String(Math.floor(i/2)).padStart(2, '0')}:${String((i % 2) * 30).padStart(2, '0')}`);
      const dayNames = ['ì¼', 'ì›”', 'í™”', 'ìˆ˜', 'ëª©', 'ê¸ˆ', 'í† '];

      useEffect(() => { loadBookings(); }, []);

      const loadBookings = async () => {
        setLoading(true);
        try {
          const { data, error } = await db.from('bookings').select('*').order('date', { ascending: false });
          if (error) throw error;
          const formattedData = data.map(b => ({
            id: b.id, venue: b.venue, court: b.court, date: b.date,
            startTime: b.start_time, endTime: b.end_time, category: b.category,
            customerName: b.customer_name, phone: b.phone || '', route: b.route || '',
            status: b.status, cancelReason: b.cancel_reason,
            repeatGroupId: b.repeat_group_id,
            createdAt: b.created_at, updatedAt: b.updated_at, cancelledAt: b.cancelled_at
          }));
          setBookings(formattedData);
        } catch (error) {
          console.error('Failed to load bookings:', error);
        }
        setLoading(false);
      };

      const saveBooking = async (booking, isUpdate = false) => {
        try {
          const dbData = {
            id: booking.id, venue: booking.venue, court: booking.court, date: booking.date,
            start_time: booking.startTime, end_time: booking.endTime, category: booking.category,
            customer_name: booking.customerName, phone: booking.phone || null, route: booking.route || null,
            status: booking.status, cancel_reason: booking.cancelReason || null,
            repeat_group_id: booking.repeatGroupId || null,
            updated_at: isUpdate ? new Date().toISOString() : null,
            cancelled_at: booking.cancelledAt || null
          };
          if (isUpdate) {
            const { error } = await db.from('bookings').update(dbData).eq('id', booking.id);
            if (error) throw error;
          } else {
            const { error } = await db.from('bookings').insert(dbData);
            if (error) throw error;
          }
          await loadBookings();
          return true;
        } catch (error) {
          console.error('Failed to save booking:', error);
          alert('ì €ì¥ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
          return false;
        }
      };

      const saveMultipleBookings = async (bookingsToSave) => {
        try {
          const batchSize = 10;
          for (let i = 0; i < bookingsToSave.length; i += batchSize) {
            const batch = bookingsToSave.slice(i, i + batchSize);
            const dbDataArray = batch.map(booking => ({
              id: booking.id, venue: booking.venue, court: booking.court, date: booking.date,
              start_time: booking.startTime, end_time: booking.endTime, category: booking.category,
              customer_name: booking.customerName, phone: booking.phone || null, route: booking.route || null,
              status: booking.status, cancel_reason: booking.cancelReason || null,
              repeat_group_id: booking.repeatGroupId || null
            }));
            const { error } = await db.from('bookings').insert(dbDataArray);
            if (error) throw error;
          }
          await loadBookings();
          return true;
        } catch (error) {
          console.error('Failed to save bookings:', error);
          alert('ì €ì¥ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
          return false;
        }
      };

      const checkTimeOverlap = (booking, excludeId = null) => {
        const timeToMinutes = (time) => { const [h, m] = time.split(':').map(Number); return h * 60 + m; };
        const newStart = timeToMinutes(booking.startTime);
        const newEnd = timeToMinutes(booking.endTime);
        return bookings.find(b => {
          if (b.id === excludeId || b.status === 'cancelled' || b.date !== booking.date || b.venue !== booking.venue || b.court !== booking.court) return false;
          const existingStart = timeToMinutes(b.startTime);
          const existingEnd = timeToMinutes(b.endTime);
          return (newStart < existingEnd && newEnd > existingStart);
        });
      };

      const getRepeatDates = (startDate, endDate, selectedDays) => {
        const dates = [];
        const start = new Date(startDate);
        const end = new Date(endDate);
        const current = new Date(start);
        while (current <= end) {
          if (selectedDays.includes(current.getDay())) {
            dates.push(`${current.getFullYear()}-${String(current.getMonth() + 1).padStart(2, '0')}-${String(current.getDate()).padStart(2, '0')}`);
          }
          current.setDate(current.getDate() + 1);
        }
        return dates;
      };

      const addBooking = async () => {
        if (!newBooking.date || !newBooking.customerName) { setRequiredAlert(true); return; }
        
        if (isRepeatMode && repeatDays.length > 0 && repeatEndDate) {
          const repeatDates = getRepeatDates(newBooking.date, repeatEndDate, repeatDays);
          const repeatGroupId = Date.now();
          const bookingsToCreate = [];
          const overlappingDates = [];
          
          for (let i = 0; i < repeatDates.length; i++) {
            const date = repeatDates[i];
            const bookingForDate = { ...newBooking, date, id: Date.now() + i, repeatGroupId };
            const overlap = checkTimeOverlap(bookingForDate);
            if (overlap) {
              overlappingDates.push(date);
            } else {
              bookingsToCreate.push(bookingForDate);
            }
          }
          
          if (overlappingDates.length > 0) {
            alert(`ë‹¤ìŒ ë‚ ì§œì— ì¤‘ë³µ ì˜ˆì•½ì´ ìˆì–´ ì œì™¸ë©ë‹ˆë‹¤:\n${overlappingDates.join('\n')}`);
          }
          
          if (bookingsToCreate.length > 0) {
            const success = await saveMultipleBookings(bookingsToCreate);
            if (success) {
              alert(`${bookingsToCreate.length}ê°œì˜ ì˜ˆì•½ì´ ìƒì„±ë˜ì—ˆìŠµë‹ˆë‹¤.`);
              resetModal();
            }
          } else {
            alert('ìƒì„±í•  ìˆ˜ ìˆëŠ” ì˜ˆì•½ì´ ì—†ìŠµë‹ˆë‹¤.');
          }
        } else {
          const overlapping = checkTimeOverlap(newBooking, editingBookingId);
          if (overlapping) { setOverlapAlert(overlapping); return; }
          const bookingData = { ...newBooking, id: isEditMode ? editingBookingId : Date.now() };
          const success = await saveBooking(bookingData, isEditMode);
          if (success) resetModal();
        }
      };

      const resetModal = () => {
        setShowModal(false);
        setIsEditMode(false);
        setEditingBookingId(null);
        setIsRepeatMode(false);
        setRepeatDays([]);
        setRepeatEndDate('');
        setNewBooking({ venue: 'ì„¸ë§ˆ', court: 'ë‹¨ì¼êµ¬ì¥', date: '', startTime: '06:00', endTime: '08:00', category: 'ëŒ€ê´€', customerName: '', phone: '', route: 'ì „í™”', status: 'active' });
      };

      const openEditModal = (booking) => {
        setSelectedBooking(null);
        setIsEditMode(true);
        setEditingBookingId(booking.id);
        setNewBooking({ venue: booking.venue, court: booking.court, date: booking.date, startTime: booking.startTime, endTime: booking.endTime, category: booking.category, customerName: booking.customerName, phone: booking.phone || '', route: booking.route || 'ì „í™”', status: booking.status });
        setShowModal(true);
      };

      const calculateEndTime = (startTime) => {
        const [h, m] = startTime.split(':').map(Number);
        const newH = (h + 2) % 24;
        return `${String(newH).padStart(2, '0')}:${String(m).padStart(2, '0')}`;
      };

      const cancelBooking = async (id, reason) => {
        const booking = bookings.find(b => b.id === id);
        if (booking) {
          await saveBooking({ ...booking, status: 'cancelled', cancelReason: reason, cancelledAt: new Date().toISOString() }, true);
        }
        setSelectedBooking(null);
        setShowCancelModal(null);
        setCancelReason('');
      };

      const handleCancelClick = (booking) => {
        if (booking.repeatGroupId) {
          const bookingDayOfWeek = new Date(booking.date).getDay();
          const futureBookings = bookings.filter(b => 
            b.repeatGroupId === booking.repeatGroupId && 
            b.status === 'active' && 
            b.date >= booking.date &&
            b.id !== booking.id &&
            new Date(b.date).getDay() === bookingDayOfWeek &&
            b.startTime === booking.startTime
          );
          if (futureBookings.length > 0) {
            setShowBulkCancelModal({ booking, futureCount: futureBookings.length });
            setSelectedBooking(null);
            return;
          }
        }
        setShowCancelModal(booking);
        setSelectedBooking(null);
      };

      const cancelSingleBooking = () => {
        setShowCancelModal(showBulkCancelModal.booking);
        setShowBulkCancelModal(null);
      };

      const cancelAllFutureBookings = async () => {
        if (!bulkCancelConfirm) {
          setBulkCancelConfirm(true);
          return;
        }
        
        const booking = showBulkCancelModal.booking;
        const bookingDayOfWeek = new Date(booking.date).getDay();
        
        try {
          // ê°™ì€ repeatGroupId, ê°™ì€ ìš”ì¼, ê°™ì€ ì‹œê°„, í•´ë‹¹ ë‚ ì§œ ì´í›„ë§Œ ì‚­ì œ
          const bookingsToDelete = bookings.filter(b => 
            b.repeatGroupId === booking.repeatGroupId && 
            b.date >= booking.date &&
            new Date(b.date).getDay() === bookingDayOfWeek &&
            b.startTime === booking.startTime
          );
          
          const idsToDelete = bookingsToDelete.map(b => b.id);
          
          const { error } = await db.from('bookings')
            .delete()
            .in('id', idsToDelete);
          
          if (error) throw error;
          await loadBookings();
          alert('ì¼ê´„ ì·¨ì†Œê°€ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤.');
        } catch (error) {
          console.error('Failed to bulk cancel:', error);
          alert('ì¼ê´„ ì·¨ì†Œì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
        }
        setShowBulkCancelModal(null);
        setBulkCancelConfirm(false);
      };

      const deleteBooking = async () => {
        if (deletePassword === '1818') {
          try {
            const { error } = await db.from('bookings').delete().eq('id', deleteId);
            if (error) throw error;
            await loadBookings();
            setDeleteId(null);
            setDeletePassword('');
            setShowDetailModal(false);
            alert('ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤.');
          } catch (error) {
            alert('ì‚­ì œì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
          }
        } else {
          alert('ë¹„ë°€ë²ˆí˜¸ê°€ ì˜¬ë°”ë¥´ì§€ ì•ŠìŠµë‹ˆë‹¤.');
        }
      };

      const handleCategoryChange = (category) => {
        if (category === 'ì†Œì…œë§¤ì¹˜') setNewBooking({ ...newBooking, category, customerName: 'í”Œë©í’‹ë³¼', phone: '', route: 'ì†Œì…œ' });
        else if (category === 'ì•„ì¹´ë°ë¯¸') setNewBooking({ ...newBooking, category, customerName: '', route: '' });
        else setNewBooking({ ...newBooking, category, customerName: '', route: 'ì „í™”' });
      };

      const getSelectedDateDay = () => {
        if (!newBooking.date) return null;
        return new Date(newBooking.date).getDay();
      };

      const toggleRepeatDay = (dayIndex) => {
        const selectedDay = getSelectedDateDay();
        if (dayIndex === selectedDay) return; // ì„ íƒí•œ ë‚ ì§œì˜ ìš”ì¼ì€ ë³€ê²½ ë¶ˆê°€
        if (repeatDays.includes(dayIndex)) {
          setRepeatDays(repeatDays.filter(d => d !== dayIndex));
        } else {
          setRepeatDays([...repeatDays, dayIndex]);
        }
      };

      const openDateModal = (date) => {
        const dateStr = `${date.getFullYear()}-${String(date.getMonth() + 1).padStart(2, '0')}-${String(date.getDate()).padStart(2, '0')}`;
        setIsEditMode(false);
        setIsRepeatMode(false);
        setRepeatDays([]);
        setRepeatEndDate('');
        setNewBooking({ venue: selectedVenue, court: selectedCourt, date: dateStr, startTime: '06:00', endTime: '08:00', category: 'ëŒ€ê´€', customerName: '', phone: '', route: 'ì „í™”', status: 'active' });
        setShowModal(true);
      };

      const showCategoryDetail = (category, period, isAllVenues = false) => {
        let filtered = [];
        if (period === 'custom') {
          const start = new Date(customDateRange.start);
          const end = new Date(customDateRange.end);
          end.setHours(23, 59, 59, 999);
          filtered = bookings.filter(b => { const d = new Date(b.date); return d >= start && d <= end; });
        }
        if (!isAllVenues && selectedVenue !== 'ì „ì²´') {
          filtered = filtered.filter(b => {
            if (b.venue !== selectedVenue) return false;
            if ((selectedVenue === 'ì„¸ë§ˆ' || selectedVenue === 'ì¶˜ì˜') && selectedCourt === 'ë‹¨ì¼êµ¬ì¥') return b.court === 'ë‹¨ì¼êµ¬ì¥' || b.court === '1êµ¬ì¥';
            return b.court === selectedCourt;
          });
        }
        if (category === 'total') { setDetailData(filtered.filter(b => b.status === 'active')); setDetailTitle(`ì§„í–‰${isAllVenues ? ' - ì „ì²´ êµ¬ì¥' : ''}`); }
        else if (category === 'cancelled') { setDetailData(filtered.filter(b => b.status === 'cancelled')); setDetailTitle(`ì·¨ì†Œ ë‚´ì—­${isAllVenues ? ' - ì „ì²´ êµ¬ì¥' : ''}`); }
        else { setDetailData(filtered.filter(b => b.category === category && b.status === 'active')); setDetailTitle(`${category}${isAllVenues ? ' - ì „ì²´ êµ¬ì¥' : ''}`); }
        setShowDetailModal(true);
      };

      const getDayBookings = (date) => {
        const dateStr = `${date.getFullYear()}-${String(date.getMonth() + 1).padStart(2, '0')}-${String(date.getDate()).padStart(2, '0')}`;
        return bookings.filter(b => {
          if (b.date !== dateStr || b.venue !== selectedVenue) return false;
          if ((selectedVenue === 'ì„¸ë§ˆ' || selectedVenue === 'ì¶˜ì˜') && selectedCourt === 'ë‹¨ì¼êµ¬ì¥') return b.court === 'ë‹¨ì¼êµ¬ì¥' || b.court === '1êµ¬ì¥';
          return b.court === selectedCourt;
        }).sort((a, b) => a.startTime.localeCompare(b.startTime));
      };

      const getStats = (period, isAllVenues = false) => {
        let filtered = [];
        if (period === 'custom') {
          const start = new Date(customDateRange.start);
          const end = new Date(customDateRange.end);
          end.setHours(23, 59, 59, 999);
          filtered = bookings.filter(b => { const d = new Date(b.date); return d >= start && d <= end; });
        }
        if (!isAllVenues && selectedVenue !== 'ì „ì²´') {
          filtered = filtered.filter(b => {
            if (b.venue !== selectedVenue) return false;
            if ((selectedVenue === 'ì„¸ë§ˆ' || selectedVenue === 'ì¶˜ì˜') && selectedCourt === 'ë‹¨ì¼êµ¬ì¥') return b.court === 'ë‹¨ì¼êµ¬ì¥' || b.court === '1êµ¬ì¥';
            return b.court === selectedCourt;
          });
        }
        const active = filtered.filter(b => b.status === 'active');
        const cancelled = filtered.filter(b => b.status === 'cancelled');
        return {
          total: active.length, cancelled: cancelled.length,
          cancelledByCategory: { 'ëŒ€ê´€': cancelled.filter(b => b.category === 'ëŒ€ê´€').length, 'ì†Œì…œë§¤ì¹˜': cancelled.filter(b => b.category === 'ì†Œì…œë§¤ì¹˜').length, 'ì•„ì¹´ë°ë¯¸': cancelled.filter(b => b.category === 'ì•„ì¹´ë°ë¯¸').length },
          categoryStats: { 'ëŒ€ê´€': active.filter(b => b.category === 'ëŒ€ê´€').length, 'ì†Œì…œë§¤ì¹˜': active.filter(b => b.category === 'ì†Œì…œë§¤ì¹˜').length, 'ì•„ì¹´ë°ë¯¸': active.filter(b => b.category === 'ì•„ì¹´ë°ë¯¸').length }
        };
      };

      const renderCalendar = () => {
        const year = currentDate.getFullYear(), month = currentDate.getMonth();
        const daysInMonth = new Date(year, month + 1, 0).getDate();
        const startingDay = new Date(year, month, 1).getDay();
        const days = [];
        for (let i = 0; i < startingDay; i++) days.push(<div key={`e${i}`} className="min-h-20 border-b border-r bg-gray-50"></div>);
        for (let day = 1; day <= daysInMonth; day++) {
          const date = new Date(year, month, day);
          const dayBookings = getDayBookings(date);
          const isToday = date.toDateString() === new Date().toDateString();
          const formatName = (name) => { if (name === 'í”Œë©í’‹ë³¼') return 'í”Œë©'; return name.length > 3 ? name.slice(0, 3) + '..' : name; };
          days.push(
            <div key={day} className={`min-h-20 border-b border-r p-0.5 overflow-y-auto cursor-pointer active:bg-gray-100 ${isToday ? 'bg-blue-50' : 'bg-white'}`} onClick={() => openDateModal(date)}>
              <div className={`text-[11px] font-semibold mb-0.5 ${isToday ? 'text-blue-600' : 'text-gray-700'}`}>{day}</div>
              <div className="space-y-0.5">
                {dayBookings.map(b => (
                  <div key={b.id} className={`text-[8px] leading-tight px-0.5 py-0.5 rounded ${categories[b.category]} ${b.status === 'cancelled' ? 'opacity-30 line-through' : ''} text-white cursor-pointer active:opacity-80`} onClick={(e) => { e.stopPropagation(); setSelectedBooking(b); }}>
                    <div>{b.startTime.split(':')[0]}ì‹œ {formatName(b.customerName)}</div>
                  </div>
                ))}
              </div>
            </div>
          );
        }
        return days;
      };

      const StatCard = ({ title, value, period, category, bgColor, isAllVenues, cancelledByCategory, stats }) => (
        <div className={`${bgColor} p-4 rounded-xl cursor-pointer`} onClick={() => showCategoryDetail(category, period, isAllVenues)}>
          <div className="text-sm text-gray-600 mb-1">{title}</div>
          <div className="text-2xl font-bold mb-2">{value}ê±´</div>
          {category === 'total' && stats && (
            <div className="mt-3 pt-3 border-t border-gray-300 space-y-2">
              <div className="flex justify-between"><span className="text-sm text-gray-700">ëŒ€ê´€</span><span className="font-bold text-green-600">{stats.categoryStats['ëŒ€ê´€']}ê±´</span></div>
              <div className="flex justify-between"><span className="text-sm text-gray-700">ì†Œì…œë§¤ì¹˜</span><span className="font-bold text-blue-600">{stats.categoryStats['ì†Œì…œë§¤ì¹˜']}ê±´</span></div>
              <div className="flex justify-between"><span className="text-sm text-gray-700">ì•„ì¹´ë°ë¯¸</span><span className="font-bold text-purple-600">{stats.categoryStats['ì•„ì¹´ë°ë¯¸']}ê±´</span></div>
            </div>
          )}
          {category === 'cancelled' && cancelledByCategory && (
            <div className="mt-3 pt-3 border-t border-gray-300 space-y-2">
              <div className="flex justify-between"><span className="text-sm text-gray-700">ëŒ€ê´€</span><span className="font-bold text-red-600">{cancelledByCategory['ëŒ€ê´€']}ê±´</span></div>
              <div className="flex justify-between"><span className="text-sm text-gray-700">ì†Œì…œë§¤ì¹˜</span><span className="font-bold text-red-600">{cancelledByCategory['ì†Œì…œë§¤ì¹˜']}ê±´</span></div>
              <div className="flex justify-between"><span className="text-sm text-gray-700">ì•„ì¹´ë°ë¯¸</span><span className="font-bold text-red-600">{cancelledByCategory['ì•„ì¹´ë°ë¯¸']}ê±´</span></div>
            </div>
          )}
        </div>
      );

      if (loading) {
        return (
          <div className="min-h-screen bg-gray-50 flex items-center justify-center">
            <div className="text-center">
              <div className="w-8 h-8 border-4 border-blue-500 border-t-transparent rounded-full animate-spin mx-auto mb-2"></div>
              <p className="text-gray-600">ë¡œë”© ì¤‘...</p>
            </div>
          </div>
        );
      }

      if (view === 'list') {
        const filtered = bookings.filter(b => {
          if (b.status !== 'active') return false;
          if (b.category === 'ì†Œì…œë§¤ì¹˜') return false;
          if (b.category === 'ì•„ì¹´ë°ë¯¸') return false;
          if (listVenue !== 'ì „ì²´' && b.venue !== listVenue) return false;
          if (searchQuery.trim() && !b.customerName.includes(searchQuery.trim()) && !(b.phone && b.phone.includes(searchQuery.trim()))) return false;
          return true;
        }).sort((a, b) => new Date(b.date) - new Date(a.date));
        const displayed = filtered.slice(0, displayCount);
        
        return (
          <div className="min-h-screen bg-gray-50">
            <div className="max-w-2xl mx-auto">
              <div className="bg-white border-b sticky top-0 z-10 p-4">
                <div className="flex items-center justify-between mb-3">
                  <button onClick={() => setView('calendar')} className="p-2 rounded-full"><CalendarIcon size={20} className="text-blue-500" /></button>
                  <h1 className="text-xl font-bold">ëŒ€ê´€ ë‚´ì—­</h1>
                  <button onClick={() => setView('stats')} className="p-2 rounded-full"><BarChartIcon size={20} className="text-blue-500" /></button>
                </div>
                <select value={listVenue} onChange={(e) => { setListVenue(e.target.value); setDisplayCount(20); }} className="w-full border rounded-lg px-3 py-2 text-sm mb-3">
                  <option value="ì „ì²´">ì „ì²´ êµ¬ì¥</option>
                  {Object.keys(venues).map(v => <option key={v} value={v}>{v}</option>)}
                </select>
                <input type="text" placeholder="ì´ë¦„ ë˜ëŠ” ì—°ë½ì²˜ ê²€ìƒ‰" value={searchQuery} onChange={(e) => { setSearchQuery(e.target.value); setDisplayCount(20); }} className="w-full border rounded-lg px-3 py-2 text-sm" />
              </div>
              <div className="p-4">
                <div className="bg-white rounded-xl shadow">
                  {displayed.length === 0 ? <p className="text-gray-500 text-center py-8">ëŒ€ê´€ ë‚´ì—­ì´ ì—†ìŠµë‹ˆë‹¤.</p> : (
                    <>
                      <div className="divide-y">
                        {displayed.map(b => (
                          <div key={b.id} className="p-4 cursor-pointer" onClick={() => setSelectedBooking(b)}>
                            <div className="flex justify-between items-start mb-2">
                              <div>
                                <div className="font-semibold flex items-center gap-1">
                                  {b.repeatGroupId && <span>ğŸ”</span>}
                                  {b.customerName}
                                </div>
                                <div className="text-sm text-gray-600">{b.venue} {b.court}</div>
                              </div>
                              <div className="text-sm text-gray-600">{b.date}</div>
                            </div>
                            <div className="flex justify-between text-sm text-gray-600">
                              <span>{b.startTime} - {b.endTime}</span><span>{b.phone || '-'}</span>
                            </div>
                          </div>
                        ))}
                      </div>
                      {filtered.length > displayCount && (
                        <div className="p-4 border-t">
                          <button onClick={() => setDisplayCount(displayCount + 20)} className="w-full bg-blue-500 text-white py-3 rounded-lg font-semibold">ë”ë³´ê¸° ({displayCount}/{filtered.length})</button>
                        </div>
                      )}
                    </>
                  )}
                </div>
              </div>
            </div>
            {selectedBooking && (
              <div className="fixed inset-0 bg-black bg-opacity-50 flex items-end z-50">
                <div className="bg-white rounded-t-3xl w-full max-w-2xl mx-auto">
                  <div className="p-4 border-b flex justify-between items-center">
                    <h3 className="text-lg font-bold">ì˜ˆì•½ ìƒì„¸</h3>
                    <button onClick={() => setSelectedBooking(null)}><XIcon size={24} /></button>
                  </div>
                  <div className="p-4 space-y-2">
                    <p><span className="text-gray-600">êµ¬ì¥:</span> {selectedBooking.venue} {selectedBooking.court}</p>
                    <p><span className="text-gray-600">ë‚ ì§œ:</span> {selectedBooking.date}</p>
                    <p><span className="text-gray-600">ì‹œê°„:</span> {selectedBooking.startTime} - {selectedBooking.endTime}</p>
                    <p><span className="text-gray-600">ì¹´í…Œê³ ë¦¬:</span> {selectedBooking.category}</p>
                    <p><span className="text-gray-600">ì˜ˆì•½ì:</span> {selectedBooking.customerName}</p>
                    <p><span className="text-gray-600">ì—°ë½ì²˜:</span> {selectedBooking.phone || '-'}</p>
                    <p><span className="text-gray-600">ì˜ˆì•½ ë£¨íŠ¸:</span> {selectedBooking.route || '-'}</p>
                    {selectedBooking.repeatGroupId && <p><span className="text-gray-600">ë°˜ë³µ ì˜ˆì•½:</span> ğŸ” ì˜ˆ</p>}
                  </div>
                </div>
              </div>
            )}
          </div>
        );
      }

      if (view === 'stats') {
        const custom = customDateRange.start && customDateRange.end ? getStats('custom', selectedVenue === 'ì „ì²´') : null;
        return (
          <div className="min-h-screen bg-gray-50">
            <div className="max-w-2xl mx-auto">
              <div className="bg-white border-b sticky top-0 z-10 p-4">
                <div className="flex items-center justify-between mb-3">
                  <div className="flex gap-2">
                    <button onClick={() => setView('calendar')} className="p-2 rounded-full"><CalendarIcon size={20} className="text-blue-500" /></button>
                    <button onClick={() => setView('list')} className="p-2 rounded-full"><ListIcon size={20} className="text-blue-500" /></button>
                  </div>
                  <h1 className="text-xl font-bold">ì§€í‘œ</h1>
                  <div className="w-20"></div>
                </div>
                <div className="flex gap-2 mb-2">
                  <select value={selectedVenue} onChange={(e) => { setSelectedVenue(e.target.value); if (e.target.value !== 'ì „ì²´') setSelectedCourt(venues[e.target.value][0]); }} className="flex-1 border rounded-lg px-3 py-2 text-sm">
                    <option value="ì „ì²´">ì „ì²´ êµ¬ì¥</option>
                    {Object.keys(venues).map(v => <option key={v} value={v}>{v}</option>)}
                  </select>
                  {selectedVenue !== 'ì „ì²´' && (
                    <select value={selectedCourt} onChange={(e) => setSelectedCourt(e.target.value)} className="flex-1 border rounded-lg px-3 py-2 text-sm">
                      {venues[selectedVenue].map(c => <option key={c} value={c}>{c}</option>)}
                    </select>
                  )}
                </div>
              </div>
              <div className="p-3">
                <div className="bg-white p-3 rounded-xl shadow">
                  <div className="space-y-2">
                    <div className="flex items-center gap-2">
                      <label className="text-xs text-gray-500 w-8">ì‹œì‘</label>
                      <input type="date" value={customDateRange.start} onChange={(e) => setCustomDateRange({...customDateRange, start: e.target.value})} className="flex-1 border rounded px-2 py-1.5 text-sm" />
                    </div>
                    <div className="flex items-center gap-2">
                      <label className="text-xs text-gray-500 w-8">ì¢…ë£Œ</label>
                      <input type="date" value={customDateRange.end} onChange={(e) => setCustomDateRange({...customDateRange, end: e.target.value})} className="flex-1 border rounded px-2 py-1.5 text-sm" />
                    </div>
                  </div>
                  {custom && (
                    <div className="grid grid-cols-2 gap-2 mt-3">
                      <StatCard title="ì§„í–‰" value={custom.total} period="custom" category="total" bgColor="bg-blue-50" isAllVenues={selectedVenue === 'ì „ì²´'} cancelledByCategory={custom.cancelledByCategory} stats={custom} />
                      <StatCard title="ì·¨ì†Œ" value={custom.cancelled} period="custom" category="cancelled" bgColor="bg-red-50" isAllVenues={selectedVenue === 'ì „ì²´'} cancelledByCategory={custom.cancelledByCategory} />
                    </div>
                  )}
                </div>
              </div>
            </div>
            {showDetailModal && (
              <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 z-50" onClick={() => setShowDetailModal(false)}>
                <div className="bg-white rounded-2xl w-full max-w-2xl max-h-[70vh] flex flex-col" onClick={(e) => e.stopPropagation()}>
                  <div className="border-b p-4 flex justify-between items-center">
                    <h3 className="text-lg font-bold">{detailTitle}</h3>
                    <button onClick={() => setShowDetailModal(false)}><XIcon size={24} /></button>
                  </div>
                  <div className="p-4 space-y-3 overflow-y-auto flex-1">
                    {detailData.length === 0 ? <p className="text-gray-500 text-center py-8">ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.</p> : 
                      detailData.map(b => (
                        <div key={b.id} className="bg-gray-50 rounded-xl p-4">
                          <div className="grid grid-cols-2 gap-2 text-sm">
                            <p><span className="text-gray-600">êµ¬ì¥:</span> {b.venue} {b.court}</p>
                            <p><span className="text-gray-600">ë‚ ì§œ:</span> {b.date}</p>
                            <p><span className="text-gray-600">ì˜ˆì•½ì:</span> {b.customerName}</p>
                            <p><span className="text-gray-600">ì¹´í…Œê³ ë¦¬:</span> {b.category}</p>
                            <p><span className="text-gray-600">ì‹œê°„:</span> {b.startTime}-{b.endTime}</p>
                            <p><span className="text-gray-600">ìœ ì…:</span> {b.route || '-'}</p>
                            <p className="col-span-2"><span className="text-gray-600">ì—°ë½ì²˜:</span> {b.phone || '-'}</p>
                            {b.cancelReason && <p className="col-span-2"><span className="text-gray-600">ì·¨ì†Œì‚¬ìœ :</span> {b.cancelReason}</p>}
                          </div>
                          {detailTitle.includes('ì·¨ì†Œ') && (
                            <button onClick={() => setDeleteId(b.id)} className="mt-2 bg-red-500 text-white px-4 py-2 rounded-lg text-sm flex items-center gap-2">
                              <TrashIcon size={16} /> ì‚­ì œ
                            </button>
                          )}
                        </div>
                      ))
                    }
                  </div>
                </div>
              </div>
            )}
            {deleteId && (
              <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 z-50">
                <div className="bg-white rounded-2xl p-6 max-w-sm w-full">
                  <h3 className="text-lg font-bold mb-4">ì˜ˆì•½ ì‚­ì œ</h3>
                  <p className="mb-4 text-sm text-gray-600">ë¹„ë°€ë²ˆí˜¸ë¥¼ ì…ë ¥í•˜ì„¸ìš”.</p>
                  <input type="password" value={deletePassword} onChange={(e) => setDeletePassword(e.target.value)} className="w-full border rounded-lg px-4 py-3 mb-4" placeholder="ë¹„ë°€ë²ˆí˜¸" />
                  <div className="flex gap-2">
                    <button onClick={deleteBooking} className="flex-1 bg-red-500 text-white py-3 rounded-lg font-semibold">ì‚­ì œ</button>
                    <button onClick={() => { setDeleteId(null); setDeletePassword(''); }} className="flex-1 bg-gray-200 py-3 rounded-lg font-semibold">ì·¨ì†Œ</button>
                  </div>
                </div>
              </div>
            )}
          </div>
        );
      }

      return (
        <div className="min-h-screen bg-gray-50">
          <div className="max-w-2xl mx-auto">
            <div className="bg-white border-b">
              <div className="p-4">
                <div className="flex items-center justify-between mb-4">
                  <div className="w-20 flex justify-start">
                    <button onClick={loadBookings} className="p-2 rounded-full"><RefreshIcon size={20} className="text-blue-500" /></button>
                  </div>
                  <h1 className="text-xl font-bold">í’‹ì‚´ê³µê°„ ì˜ˆì•½ê´€ë¦¬</h1>
                  <div className="w-20 flex justify-end gap-1">
                    <button onClick={() => setView('list')} className="p-2 rounded-full"><ListIcon size={20} className="text-blue-500" /></button>
                    <button onClick={() => setView('stats')} className="p-2 rounded-full"><BarChartIcon size={20} className="text-blue-500" /></button>
                  </div>
                </div>
                <div className="flex gap-2">
                  <select value={selectedVenue} onChange={(e) => { setSelectedVenue(e.target.value); setSelectedCourt(venues[e.target.value][0]); }} className="flex-1 border rounded-lg px-3 py-2 text-sm">
                    {Object.keys(venues).map(v => <option key={v} value={v}>{v}</option>)}
                  </select>
                  <select value={selectedCourt} onChange={(e) => setSelectedCourt(e.target.value)} className="flex-1 border rounded-lg px-3 py-2 text-sm">
                    {venues[selectedVenue].map(c => <option key={c} value={c}>{c}</option>)}
                  </select>
                </div>
              </div>
              <div className="px-4 pb-3 flex items-center justify-between">
                <button onClick={() => setCurrentDate(new Date(currentDate.getFullYear(), currentDate.getMonth() - 1))} className="text-blue-500 font-medium text-sm">ì´ì „</button>
                <h2 className="text-base font-bold">{currentDate.getFullYear()}ë…„ {currentDate.getMonth() + 1}ì›”</h2>
                <button onClick={() => setCurrentDate(new Date(currentDate.getFullYear(), currentDate.getMonth() + 1))} className="text-blue-500 font-medium text-sm">ë‹¤ìŒ</button>
              </div>
              <div className="grid grid-cols-7 border-t">
                {['ì¼', 'ì›”', 'í™”', 'ìˆ˜', 'ëª©', 'ê¸ˆ', 'í† '].map((d, i) => <div key={d} className={`text-center text-xs font-semibold py-2 border-r ${i === 0 ? 'text-red-500' : i === 6 ? 'text-blue-500' : 'text-gray-600'}`}>{d}</div>)}
              </div>
            </div>
            <div className="grid grid-cols-7 border-l">{renderCalendar()}</div>
            <div className="p-4 flex gap-3 bg-white border-t">
              {Object.entries(categories).map(([cat, color]) => (<div key={cat} className="flex items-center gap-1.5"><div className={`w-3 h-3 ${color} rounded-full`}></div><span className="text-xs text-gray-600">{cat}</span></div>))}
            </div>
          </div>

          {showModal && (
            <div className="fixed inset-0 bg-black bg-opacity-50 flex items-start justify-center pt-10 z-50 overflow-y-auto overflow-x-hidden">
              <div className="bg-white rounded-2xl w-full max-w-md mx-4 mb-10 max-h-[85vh] overflow-y-auto overflow-x-hidden">
                <div className="sticky top-0 bg-white border-b p-4 flex justify-between items-center rounded-t-2xl">
                  <button onClick={resetModal} className="text-blue-500 font-medium">ì·¨ì†Œ</button>
                  <h3 className="text-lg font-bold">{isEditMode ? 'ì˜ˆì•½ ìˆ˜ì •' : 'ìƒˆ ì˜ˆì•½'}</h3>
                  <button onClick={addBooking} className="text-blue-500 font-medium">ì™„ë£Œ</button>
                </div>
                <div className="p-4 space-y-4">
                  <div className="grid grid-cols-2 gap-3">
                    <div><label className="block text-sm font-medium mb-1.5">êµ¬ì¥</label><select value={newBooking.venue} onChange={(e) => setNewBooking({...newBooking, venue: e.target.value, court: venues[e.target.value][0]})} className="w-full border rounded-lg px-3 py-2.5">{Object.keys(venues).map(v => <option key={v} value={v}>{v}</option>)}</select></div>
                    <div><label className="block text-sm font-medium mb-1.5">ì½”íŠ¸</label><select value={newBooking.court} onChange={(e) => setNewBooking({...newBooking, court: e.target.value})} className="w-full border rounded-lg px-3 py-2.5">{venues[newBooking.venue].map(c => <option key={c} value={c}>{c}</option>)}</select></div>
                  </div>
                  <div><label className="block text-sm font-medium mb-1.5">ë‚ ì§œ *</label><input type="date" value={newBooking.date} onChange={(e) => setNewBooking({...newBooking, date: e.target.value})} className="w-full border rounded-lg px-3 py-2.5" /></div>
                  <div className="grid grid-cols-2 gap-3">
                    <div><label className="block text-sm font-medium mb-1.5">ì‹œì‘</label><select value={newBooking.startTime} onChange={(e) => setNewBooking({...newBooking, startTime: e.target.value, endTime: calculateEndTime(e.target.value)})} className="w-full border rounded-lg px-3 py-2.5">{timeSlots.map(t => <option key={t} value={t}>{t}</option>)}</select></div>
                    <div><label className="block text-sm font-medium mb-1.5">ì¢…ë£Œ</label><select value={newBooking.endTime} onChange={(e) => setNewBooking({...newBooking, endTime: e.target.value})} className="w-full border rounded-lg px-3 py-2.5">{timeSlots.map(t => <option key={t} value={t}>{t}</option>)}</select></div>
                  </div>
                  <div><label className="block text-sm font-medium mb-1.5">ì¹´í…Œê³ ë¦¬</label><select value={newBooking.category} onChange={(e) => handleCategoryChange(e.target.value)} className="w-full border rounded-lg px-3 py-2.5">{Object.keys(categories).map(c => <option key={c} value={c}>{c}</option>)}</select></div>
                  <div><label className="block text-sm font-medium mb-1.5">ì˜ˆì•½ìëª… * {newBooking.category === 'ì†Œì…œë§¤ì¹˜' && <span className="text-xs text-gray-500">(ìë™: í”Œë©í’‹ë³¼)</span>}</label><input type="text" value={newBooking.customerName} onChange={(e) => setNewBooking({...newBooking, customerName: e.target.value})} disabled={newBooking.category === 'ì†Œì…œë§¤ì¹˜'} className="w-full border rounded-lg px-3 py-2.5 disabled:bg-gray-100" placeholder="í™ê¸¸ë™" /></div>
                  <div><label className="block text-sm font-medium mb-1.5">ì—°ë½ì²˜ <span className="text-xs text-gray-500">(ì„ íƒì‚¬í•­)</span></label><input type="tel" value={newBooking.phone} onChange={(e) => setNewBooking({...newBooking, phone: e.target.value.replace(/[^0-9]/g, '')})} className="w-full border rounded-lg px-3 py-2.5" placeholder="01012345678" inputMode="numeric" /></div>
                  {newBooking.category !== 'ì†Œì…œë§¤ì¹˜' && newBooking.category !== 'ì•„ì¹´ë°ë¯¸' && (<div><label className="block text-sm font-medium mb-1.5">ì˜ˆì•½ ë£¨íŠ¸</label><select value={newBooking.route} onChange={(e) => setNewBooking({...newBooking, route: e.target.value})} className="w-full border rounded-lg px-3 py-2.5"><option value="ì „í™”">ì „í™”</option><option value="ë¬¸ì">ë¬¸ì</option><option value="ì¹´ì¹´ì˜¤í†¡ì±„ë„">ì¹´ì¹´ì˜¤í†¡ì±„ë„</option><option value="ë„¤ì´ë²„ëŒ€ê´€">ë„¤ì´ë²„ëŒ€ê´€</option><option value="í”Œë©ëŒ€ê´€">í”Œë©ëŒ€ê´€</option></select></div>)}
                  {newBooking.category === 'ì†Œì…œë§¤ì¹˜' && (<div><label className="block text-sm font-medium mb-1.5">ì˜ˆì•½ ë£¨íŠ¸</label><input type="text" value="ì†Œì…œ" disabled className="w-full border rounded-lg px-3 py-2.5 bg-gray-100" /></div>)}
                  
                  {!isEditMode && (
                    <div className="border-t pt-4">
                      <div className="flex items-center justify-between mb-3">
                        <label className="text-sm font-medium flex items-center gap-2">
                          <RepeatIcon size={18} className="text-blue-500" />
                          ë°˜ë³µ ì˜ˆì•½
                        </label>
                        <button 
                          onClick={() => {
                            if (!isRepeatMode) {
                              const selectedDay = getSelectedDateDay();
                              if (selectedDay !== null) {
                                setRepeatDays([selectedDay]);
                              }
                            } else {
                              setRepeatDays([]);
                            }
                            setIsRepeatMode(!isRepeatMode);
                          }} 
                          className={`w-12 h-6 rounded-full transition-colors ${isRepeatMode ? 'bg-blue-500' : 'bg-gray-300'}`}
                        >
                          <div className={`w-5 h-5 bg-white rounded-full shadow transition-transform ${isRepeatMode ? 'translate-x-6' : 'translate-x-0.5'}`}></div>
                        </button>
                      </div>
                      
                      {isRepeatMode && (
                        <div className="space-y-3 bg-blue-50 p-3 rounded-lg">
                          <div>
                            <label className="block text-sm font-medium mb-2">ë°˜ë³µ ìš”ì¼ ì„ íƒ</label>
                            <div className="flex gap-1">
                              {dayNames.map((day, index) => {
                                const isSelectedDay = index === getSelectedDateDay();
                                const isActive = repeatDays.includes(index);
                                return (
                                  <button
                                    key={index}
                                    onClick={() => toggleRepeatDay(index)}
                                    className={`flex-1 py-2 text-sm rounded-lg font-medium transition-colors ${
                                      isActive 
                                        ? isSelectedDay 
                                          ? 'bg-blue-700 text-white cursor-not-allowed' 
                                          : 'bg-blue-500 text-white'
                                        : 'bg-white text-gray-600 border'
                                    }`}
                                  >
                                    {day}{isSelectedDay && ' âœ“'}
                                  </button>
                                );
                              })}
                            </div>
                          </div>
                          <div>
                            <label className="block text-sm font-medium mb-1.5">ë°˜ë³µ ì¢…ë£Œì¼</label>
                            <input 
                              type="date" 
                              value={repeatEndDate} 
                              onChange={(e) => setRepeatEndDate(e.target.value)} 
                              min={newBooking.date}
                              className="w-full border rounded-lg px-3 py-2.5" 
                            />
                          </div>
                          {repeatDays.length > 0 && repeatEndDate && newBooking.date && (
                            <div className="text-sm text-blue-600 bg-white p-2 rounded">
                              ğŸ“… {getRepeatDates(newBooking.date, repeatEndDate, repeatDays).length}ê°œì˜ ì˜ˆì•½ì´ ìƒì„±ë©ë‹ˆë‹¤
                            </div>
                          )}
                        </div>
                      )}
                    </div>
                  )}
                </div>
              </div>
            </div>
          )}

          {selectedBooking && (
            <div className="fixed inset-0 bg-black bg-opacity-50 flex items-end z-50">
              <div className="bg-white rounded-t-3xl w-full max-w-2xl mx-auto">
                <div className="p-4 border-b flex justify-between items-center">
                  <h3 className="text-lg font-bold">ì˜ˆì•½ ìƒì„¸</h3>
                  <button onClick={() => setSelectedBooking(null)}><XIcon size={24} /></button>
                </div>
                <div className="p-4 space-y-2">
                  <p><span className="text-gray-600">êµ¬ì¥:</span> {selectedBooking.venue} {selectedBooking.court}</p>
                  <p><span className="text-gray-600">ë‚ ì§œ:</span> {selectedBooking.date}</p>
                  <p><span className="text-gray-600">ì‹œê°„:</span> {selectedBooking.startTime} - {selectedBooking.endTime}</p>
                  <p><span className="text-gray-600">ì¹´í…Œê³ ë¦¬:</span> {selectedBooking.category}</p>
                  <p><span className="text-gray-600">ì˜ˆì•½ì:</span> {selectedBooking.customerName}</p>
                  <p><span className="text-gray-600">ì—°ë½ì²˜:</span> {selectedBooking.phone || '-'}</p>
                  <p><span className="text-gray-600">ì˜ˆì•½ ë£¨íŠ¸:</span> {selectedBooking.route || '-'}</p>
                  <p><span className="text-gray-600">ìƒíƒœ:</span> {selectedBooking.status === 'active' ? 'í™œì„±' : 'ì·¨ì†Œë¨'}</p>
                  {selectedBooking.repeatGroupId && <p><span className="text-gray-600">ë°˜ë³µ ì˜ˆì•½:</span> ğŸ” ì˜ˆ</p>}
                </div>
                {selectedBooking.status === 'active' && (
                  <div className="p-4 border-t flex gap-3">
                    <button onClick={() => openEditModal(selectedBooking)} className="flex-1 bg-blue-500 text-white py-3 rounded-lg font-semibold flex items-center justify-center gap-2"><EditIcon size={18} /> ì˜ˆì•½ ìˆ˜ì •</button>
                    <button onClick={() => handleCancelClick(selectedBooking)} className="flex-1 bg-red-500 text-white py-3 rounded-lg font-semibold flex items-center justify-center gap-2"><XIcon size={18} /> ì˜ˆì•½ ì·¨ì†Œ</button>
                  </div>
                )}
              </div>
            </div>
          )}

          {overlapAlert && (
            <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 z-50">
              <div className="bg-white rounded-2xl p-6 max-w-sm w-full">
                <h3 className="text-lg font-bold mb-4 text-red-500">ì˜ˆì•½ ë¶ˆê°€</h3>
                <p className="mb-2 text-sm text-gray-600">í•´ë‹¹ ì‹œê°„ì— ì´ë¯¸ ì˜ˆì•½ì´ ìˆìŠµë‹ˆë‹¤.</p>
                <div className="bg-gray-100 rounded-lg p-3 mb-4">
                  <p className="text-sm"><span className="text-gray-600">ì˜ˆì•½ì:</span> {overlapAlert.customerName}</p>
                  <p className="text-sm"><span className="text-gray-600">ì‹œê°„:</span> {overlapAlert.startTime} - {overlapAlert.endTime}</p>
                </div>
                <button onClick={() => setOverlapAlert(null)} className="w-full bg-blue-500 text-white py-3 rounded-lg font-semibold">í™•ì¸</button>
              </div>
            </div>
          )}

          {showCancelModal && (
            <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 z-50">
              <div className="bg-white rounded-2xl p-6 max-w-sm w-full">
                <h3 className="text-lg font-bold mb-4">ì˜ˆì•½ ì·¨ì†Œ</h3>
                <p className="mb-2 text-sm text-gray-600">ì·¨ì†Œ ì‚¬ìœ ë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”.</p>
                <textarea value={cancelReason} onChange={(e) => setCancelReason(e.target.value)} className="w-full border rounded-lg px-4 py-3 mb-4 h-24 resize-none" placeholder="ì·¨ì†Œ ì‚¬ìœ  ì…ë ¥" />
                <div className="flex gap-2">
                  <button onClick={() => cancelBooking(showCancelModal.id, cancelReason)} className="flex-1 bg-red-500 text-white py-3 rounded-lg font-semibold">ì·¨ì†Œ í™•ì¸</button>
                  <button onClick={() => { setShowCancelModal(null); setCancelReason(''); }} className="flex-1 bg-gray-200 py-3 rounded-lg font-semibold">ë‹«ê¸°</button>
                </div>
              </div>
            </div>
          )}

          {showBulkCancelModal && (
            <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 z-50">
              <div className="bg-white rounded-2xl p-6 max-w-sm w-full">
                <h3 className="text-lg font-bold mb-4">ë°˜ë³µ ì˜ˆì•½ ì·¨ì†Œ</h3>
                {!bulkCancelConfirm ? (
                  <>
                    <p className="mb-4 text-sm text-gray-600">
                      ì´ ì˜ˆì•½ì€ ë°˜ë³µ ì˜ˆì•½ì…ë‹ˆë‹¤.<br/>
                      ë§¤ì£¼ <strong>{dayNames[new Date(showBulkCancelModal.booking.date).getDay()]}ìš”ì¼ {showBulkCancelModal.booking.startTime}</strong> ì¼ì •ì´<br/>
                      ì´í›„ <strong>{showBulkCancelModal.futureCount}ê°œ</strong> ë” ìˆìŠµë‹ˆë‹¤.
                    </p>
                    <div className="space-y-2">
                      <button onClick={cancelSingleBooking} className="w-full bg-orange-500 text-white py-3 rounded-lg font-semibold">ì´ ì¼ì •ë§Œ ì·¨ì†Œ</button>
                      <button onClick={cancelAllFutureBookings} className="w-full bg-red-500 text-white py-3 rounded-lg font-semibold">ì´í›„ ê°™ì€ ìš”ì¼/ì‹œê°„ ëª¨ë‘ ì·¨ì†Œ</button>
                      <button onClick={() => { setShowBulkCancelModal(null); setBulkCancelConfirm(false); }} className="w-full bg-gray-200 py-3 rounded-lg font-semibold">ë’¤ë¡œê°€ê¸°</button>
                    </div>
                  </>
                ) : (
                  <>
                    <div className="bg-red-50 border border-red-200 rounded-lg p-4 mb-4">
                      <p className="text-sm text-red-600 font-medium">âš ï¸ ì£¼ì˜</p>
                      <p className="text-sm text-red-600 mt-1">ì¼ê´„ ì·¨ì†Œí•˜ê²Œ ë˜ë©´ í•´ë‹¹ ì·¨ì†ŒëŠ” ë³µêµ¬ë˜ì§€ ì•ŠìŠµë‹ˆë‹¤.</p>
                      <p className="text-sm text-red-600 mt-1">ì‹¤í–‰í•˜ì‹œê² ìŠµë‹ˆê¹Œ?</p>
                    </div>
                    <div className="space-y-2">
                      <button onClick={cancelAllFutureBookings} className="w-full bg-red-500 text-white py-3 rounded-lg font-semibold">ì¼ì • ì·¨ì†Œ</button>
                      <button onClick={() => { setShowBulkCancelModal(null); setBulkCancelConfirm(false); }} className="w-full bg-gray-200 py-3 rounded-lg font-semibold">ë’¤ë¡œê°€ê¸°</button>
                    </div>
                  </>
                )}
              </div>
            </div>
          )}

          {requiredAlert && (
            <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 z-50">
              <div className="bg-white rounded-2xl p-6 max-w-sm w-full">
                <h3 className="text-lg font-bold mb-4 text-red-500">ì…ë ¥ ì˜¤ë¥˜</h3>
                <p className="mb-4 text-sm text-gray-600">í•„ìˆ˜ê°’ì´ ì…ë ¥ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤.<br/>ë‚ ì§œì™€ ì˜ˆì•½ìëª…ì„ í™•ì¸í•´ì£¼ì„¸ìš”.</p>
                <button onClick={() => setRequiredAlert(false)} className="w-full bg-blue-500 text-white py-3 rounded-lg font-semibold">í™•ì¸</button>
              </div>
            </div>
          )}
        </div>
      );
    };

    ReactDOM.createRoot(document.getElementById('root')).render(<FutsalBookingSystem />);
  </script>
</body>
</html>
